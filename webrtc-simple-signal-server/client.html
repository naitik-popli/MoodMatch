<!DOCTYPE html>
<html>
<head>
  <title>Simple WebRTC Video Chat</title>
  <style>
    video {
      width: 45%;
      margin: 2%;
      border: 1px solid black;
    }
  </style>
</head>
<body>
  <h1>Simple WebRTC Video Chat with Signaling Server</h1>
  <video id="localVideo" autoplay muted></video>
  <video id="remoteVideo" autoplay></video>

  <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
  <script>
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');

    // Use the backend URL provided for WebSocket connection
    const ws = new WebSocket('wss://moodmatch-1.onrender.com');
    let peer;

    function requestMediaPermissions() {
      return new Promise((resolve, reject) => {
        // Use secure context check for getUserMedia
        if (!window.isSecureContext) {
          reject(new Error('getUserMedia requires a secure context (HTTPS or localhost)'));
          return;
        }
        const getUserMedia = navigator.mediaDevices && navigator.mediaDevices.getUserMedia
          ? navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices)
          : (navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || function() { return Promise.reject(new Error('getUserMedia is not implemented')); }).bind(navigator);
        getUserMedia({ video: true, audio: true })
          .then(stream => resolve(stream))
          .catch(err => {
            console.error('getUserMedia error:', err);
            alert('Error accessing camera/microphone: ' + err.message);
            reject(err);
          });
      });
    }

    requestMediaPermissions()
      .then(stream => {
        localVideo.srcObject = stream;

        // Create peer with initiator true or false based on URL hash
        const isInitiator = location.hash === '#1';

        peer = new SimplePeer({
          initiator: isInitiator,
          trickle: false,
          stream: stream
        });

        ws.onmessage = (message) => {
          const signal = JSON.parse(message.data);
          if (signal.type === 'offer' || signal.type === 'answer' || signal.type === 'candidate') {
            peer.signal(signal);
          }
        };

        peer.on('signal', data => {
          ws.send(JSON.stringify(data));
        });

        peer.on('stream', stream => {
          remoteVideo.srcObject = stream;
        });

        peer.on('error', err => {
          console.error('Peer error:', err);
        });
      })
      .catch(err => {
        console.error('getUserMedia error:', err);
      });
  </script>
</body>
</html>
